<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login Monitor (Silent Stats + IME)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    .container {
      max-width: 620px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
    }
    .input-group { margin-bottom: 18px; }
    .input-group label { display:block; margin-bottom:8px; font-size:14px; }
    .input-group input {
      width:100%;
      padding:10px;
      font-size:14px;
      border:1px solid #ddd;
      border-radius:4px;
    }
    .btn {
      width: 100%;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover { background-color:#45a049; }

    .stats {
      margin-top: 14px;
      padding: 12px;
      border: 1px solid #e6e6e6;
      border-radius: 6px;
      background: #fafafa;
      font-size: 13px;
      line-height: 1.6;
    }
    .stats h3 { margin:0 0 8px; font-size: 14px; }

    .kv { display:flex; justify-content:space-between; gap:12px; }
    .kv b {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    .badge {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      margin-left: 6px;
    }
    .ok { border-color: rgba(76,175,80,.35); background: rgba(76,175,80,.08); }
    .warn { border-color: rgba(255,193,7,.5); background: rgba(255,193,7,.12); }
    .bad { border-color: rgba(244,67,54,.45); background: rgba(244,67,54,.10); }

    .log {
      margin-top: 14px;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 260px;
      overflow-y: auto;
    }
    .btn-row { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .btn-small { width:auto; padding:8px 10px; font-size: 13px; cursor:pointer; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Login</h2>

    <form id="loginForm">
      <div class="input-group">
        <label for="username">Username</label>
        <input type="text" id="username" autocomplete="username" />
      </div>

      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" autocomplete="current-password" />
      </div>

      <button type="submit" class="btn" id="loginButton">Login</button>
    </form>

    <!-- Stats Panel (English) -->
    <div class="stats" id="statsPanel">
      <h3>
        Statistics
        <span class="badge" id="badgePaste">paste: 0</span>
      </h3>

      <div class="kv"><span>Username focus → Password interaction</span><b id="s_u2p">-</b></div>
      <div class="kv"><span>Password interaction → Login click</span><b id="s_p2l">-</b></div>

      <div class="kv"><span>Paste count == 2</span><b id="s_paste_eq2">false</b></div>
      <div class="kv"><span>Paste count &gt; 2</span><b id="s_paste_gt2">false</b></div>

      <div class="kv"><span>Password Shift key count</span><b id="s_shift_pw">0</b></div>
      <div class="kv"><span>Password CapsLock count</span><b id="s_caps_pw">0</b></div>

      <div class="kv"><span>Username IME composition count</span><b id="s_ime_user">0</b></div>
      <div class="kv"><span>Password IME composition count</span><b id="s_ime_pass">0</b></div>

      <!-- ✅ NEW: keydown counts -->
      <div class="kv"><span>Username keydown count</span><b id="s_kd_user">0</b></div>
      <div class="kv"><span>Password keydown count</span><b id="s_kd_pass">0</b></div>
    </div>

    <div class="log" id="log"></div>

    <div class="btn-row">
      <button class="btn-small" id="downloadLogBtn" type="button">Download Log</button>
      <button class="btn-small" id="clearLogBtn" type="button">Clear Log</button>
    </div>
  </div>

<script>
/* ===================== utils ===================== */
function ts(){ return new Date().toISOString(); }
function nowMs(){ return Date.now(); }
function safeText(s, maxLen=200){
  if (s == null) return "";
  s = String(s);
  return s.length > maxLen ? s.slice(0,maxLen) + "…(" + s.length + ")" : s;
}

/* ===================== DOM ===================== */
const usernameField = document.getElementById("username");
const passwordField = document.getElementById("password");
const loginButton   = document.getElementById("loginButton");
const form          = document.getElementById("loginForm");
const logEl         = document.getElementById("log");
const downloadLogBtn= document.getElementById("downloadLogBtn");
const clearLogBtn   = document.getElementById("clearLogBtn");

const s_u2p = document.getElementById("s_u2p");
const s_p2l = document.getElementById("s_p2l");
const s_paste_eq2 = document.getElementById("s_paste_eq2");
const s_paste_gt2 = document.getElementById("s_paste_gt2");
const s_shift_pw  = document.getElementById("s_shift_pw");
const s_caps_pw   = document.getElementById("s_caps_pw");
const s_ime_user  = document.getElementById("s_ime_user");
const s_ime_pass  = document.getElementById("s_ime_pass");
const s_kd_user   = document.getElementById("s_kd_user");
const s_kd_pass   = document.getElementById("s_kd_pass");
const badgePaste  = document.getElementById("badgePaste");

/* ===================== logs ===================== */
const logs = [];
function appendLogLine(line){
  logEl.textContent += line + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}
function logEvent(type, detail={}){
  const entry = { t: ts(), t_ms: nowMs(), type, ...detail };
  logs.push(entry);
  appendLogLine(`${entry.t}  [${type}]  ${JSON.stringify(detail)}`);
}

/* ===================== stats state ===================== */
// timing: username focus -> password interaction
let tFocusUsernameMs = null;
let tPasswordTouchMs = null;

// timing: password interaction -> login click
let tLoginClickMs = null;

// paste
let pasteCount = 0;

// password shift/capslock
let pwShiftCount = 0;
let pwCapsCount = 0;
let lastCapsState = null;

// IME signals
let imeUsernameCount = 0;
let imePasswordCount = 0;
let lastCompositionAtUsernameMs = null;
let lastCompositionAtPasswordMs = null;

// ✅ NEW: keydown counters
let usernameKeydownCount = 0;
let passwordKeydownCount = 0;

/* ===================== helpers ===================== */
function delta(a,b){
  if (typeof a !== "number" || typeof b !== "number") return "-";
  const d = b - a;
  return (d >= 0 && Number.isFinite(d)) ? `${d} ms` : "-";
}

function snapshotStats(){
  return {
    usernameToPasswordMs:
      (typeof tFocusUsernameMs === "number" && typeof tPasswordTouchMs === "number")
        ? (tPasswordTouchMs - tFocusUsernameMs)
        : null,
    passwordToLoginMs:
      (typeof tPasswordTouchMs === "number" && typeof tLoginClickMs === "number")
        ? (tLoginClickMs - tPasswordTouchMs)
        : null,
    pasteCount,
    pasteEq2: pasteCount === 2,
    pasteGt2: pasteCount > 2,
    passwordShiftCount: pwShiftCount,
    passwordCapsLockCount: pwCapsCount,
    usernameIMECompositionCount: imeUsernameCount,
    passwordIMECompositionCount: imePasswordCount,
    usernameKeydownCount,
    passwordKeydownCount,
    lastCompositionAtUsernameMs,
    lastCompositionAtPasswordMs
  };
}

// avoid flooding logs with stats_update
let lastStatsSig = "";
function updateStatsUIAndMaybeLog(){
  s_u2p.textContent = delta(tFocusUsernameMs, tPasswordTouchMs);
  s_p2l.textContent = delta(tPasswordTouchMs, tLoginClickMs);

  s_paste_eq2.textContent = String(pasteCount === 2);
  s_paste_gt2.textContent = String(pasteCount > 2);

  s_shift_pw.textContent = String(pwShiftCount);
  s_caps_pw.textContent  = String(pwCapsCount);

  s_ime_user.textContent = String(imeUsernameCount);
  s_ime_pass.textContent = String(imePasswordCount);

  // ✅ NEW
  s_kd_user.textContent = String(usernameKeydownCount);
  s_kd_pass.textContent = String(passwordKeydownCount);

  badgePaste.textContent = `paste: ${pasteCount}`;
  badgePaste.classList.remove("ok","warn","bad");
  if (pasteCount === 0) badgePaste.classList.add("ok");
  else if (pasteCount <= 2) badgePaste.classList.add("warn");
  else badgePaste.classList.add("bad");

  const stats = snapshotStats();
  const sig = JSON.stringify({
    u2p: stats.usernameToPasswordMs,
    p2l: stats.passwordToLoginMs,
    pc: stats.pasteCount,
    sh: stats.passwordShiftCount,
    ca: stats.passwordCapsLockCount,
    iu: stats.usernameIMECompositionCount,
    ip: stats.passwordIMECompositionCount,
    ku: stats.usernameKeydownCount,     // ✅ NEW
    kp: stats.passwordKeydownCount      // ✅ NEW
  });

  if (sig !== lastStatsSig){
    lastStatsSig = sig;
    logEvent("stats_update", stats);
  }
}

/* ===================== IME detectors ===================== */
function bumpIME(field, via){
  if (field === "username") {
    imeUsernameCount++;
    lastCompositionAtUsernameMs = nowMs();
  } else {
    imePasswordCount++;
    lastCompositionAtPasswordMs = nowMs();
  }
  logEvent("ime_detected", { field, via });
}

function attachCompositionListeners(inputEl, field){
  inputEl.addEventListener("compositionstart", (e) => {
    bumpIME(field, "compositionstart");
    logEvent("compositionstart", { field, data: safeText(e.data, 120) });
    updateStatsUIAndMaybeLog();
  });

  inputEl.addEventListener("compositionupdate", (e) => {
    if (field === "username") lastCompositionAtUsernameMs = nowMs();
    else lastCompositionAtPasswordMs = nowMs();
    logEvent("compositionupdate", { field, data: safeText(e.data, 120) });
  });

  inputEl.addEventListener("compositionend", (e) => {
    if (field === "username") lastCompositionAtUsernameMs = nowMs();
    else lastCompositionAtPasswordMs = nowMs();
    logEvent("compositionend", { field, data: safeText(e.data, 120) });
  });
}

function markIMEFromKeydown(field, e){
  const maybeIME = (e.isComposing === true) || (e.keyCode === 229);
  if (maybeIME){
    logEvent("ime_hint", { field, via: "keydown", isComposing: !!e.isComposing, keyCode: e.keyCode });
  }
}

/* ===================== core listeners ===================== */
// username focus
usernameField.addEventListener("focus", ()=>{
  if (tFocusUsernameMs == null) tFocusUsernameMs = nowMs();
  logEvent("focus", { field:"username" });
  updateStatsUIAndMaybeLog();
});
usernameField.addEventListener("blur", ()=>logEvent("blur", { field:"username" }));

// password touched (click/focus)
function markPasswordTouched(trigger){
  if (tPasswordTouchMs == null){
    tPasswordTouchMs = nowMs();
    logEvent("password_touched", { trigger });
    updateStatsUIAndMaybeLog();
  }
}
passwordField.addEventListener("pointerdown", ()=>markPasswordTouched("pointerdown"));
passwordField.addEventListener("mousedown",   ()=>markPasswordTouched("mousedown"));
passwordField.addEventListener("focus",       ()=>{ markPasswordTouched("focus"); logEvent("focus", { field:"password" }); });
passwordField.addEventListener("blur",        ()=>logEvent("blur", { field:"password" }));

// keydowns
usernameField.addEventListener("keydown", (e)=>{
  usernameKeydownCount++; // ✅ NEW
  markIMEFromKeydown("username", e);
  logEvent("keydown", { field:"username", key:e.key, code:e.code, shift:e.shiftKey });
  updateStatsUIAndMaybeLog(); // optional: keep for UI refresh
});

passwordField.addEventListener("keydown", (e)=>{
  passwordKeydownCount++; // ✅ NEW
  markIMEFromKeydown("password", e);

  if (e.key === "Shift") pwShiftCount++;
  if (e.key === "CapsLock") pwCapsCount++;

  // CapsLock state change heuristic
  try{
    const caps = !!(e.getModifierState && e.getModifierState("CapsLock"));
    if (lastCapsState === null) lastCapsState = caps;
    else if (caps !== lastCapsState){
      pwCapsCount++;
      lastCapsState = caps;
      logEvent("capslock_state_change", { field:"password", caps });
    }
  }catch{}

  logEvent("keydown", { field:"password", key:e.key, code:e.code, shift:e.shiftKey });
  updateStatsUIAndMaybeLog();
});

// beforeinput (also detect insertCompositionText)
function onBeforeInput(field, e){
  logEvent("beforeinput", {
    field,
    inputType: e.inputType,
    data: safeText(e.data, 200)
  });

  if (e.inputType === "insertCompositionText"){
    bumpIME(field, "beforeinput.insertCompositionText");
    updateStatsUIAndMaybeLog();
  }
}
usernameField.addEventListener("beforeinput", (e)=>onBeforeInput("username", e));
passwordField.addEventListener("beforeinput", (e)=>onBeforeInput("password", e));

// input
usernameField.addEventListener("input", (e)=>{
  logEvent("input", { field:"username", inputType: e.inputType || null });
});
passwordField.addEventListener("input", (e)=>{
  logEvent("input", { field:"password", inputType: e.inputType || null });
});

// composition listeners (real IME)
attachCompositionListeners(usernameField, "username");
attachCompositionListeners(passwordField, "password");

// paste (count + classify eq2/gt2)
function onPaste(field, e){
  pasteCount++;
  let pastedText = "";
  try { pastedText = (e.clipboardData || window.clipboardData)?.getData("text") || ""; } catch {}
  logEvent("paste", { field, pasted: safeText(pastedText, 200), pastedLen: pastedText.length });
  updateStatsUIAndMaybeLog();
}
usernameField.addEventListener("paste", (e)=>onPaste("username", e));
passwordField.addEventListener("paste", (e)=>onPaste("password", e));

// login click timing
loginButton.addEventListener("click", ()=>{
  if (tLoginClickMs == null) tLoginClickMs = nowMs();
  logEvent("login_clicked", {});
  updateStatsUIAndMaybeLog();
});

/* ===================== submit (always success) ===================== */
form.addEventListener("submit", (e)=>{
  e.preventDefault();
  const username = usernameField.value || "";
  const password = passwordField.value || "";
  logEvent("submit", { username: safeText(username, 80), passwordLen: password.length });

  // Always success
  logEvent("login_success", { username: safeText(username, 80) });
});

/* ===================== export ===================== */
downloadLogBtn.addEventListener("click", ()=>{
  const payload = {
    exportedAt: ts(),
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    stats: snapshotStats(),
    logs
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "login_stats_log_with_ime.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

clearLogBtn.addEventListener("click", ()=>{
  logEl.textContent = "";
  logEvent("log_cleared", {});
});

/* ===================== init ===================== */
window.addEventListener("DOMContentLoaded", ()=>{
  logEvent("init", {});
  updateStatsUIAndMaybeLog();
});
</script>
</body>
</html>
